name: ğŸš´ Stolen Bike Finder - CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Health check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ========================================
    # ğŸ”„ SETUP PHASE
    # ========================================
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Install docker-compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
      
    - name: ğŸ”§ Create data directory
      run: |
        cd mvp
        mkdir -p data
        chmod 755 data
        
    # ========================================
    # ğŸ—ï¸ BUILD PHASE
    # ========================================
    - name: ğŸ—ï¸ Build Docker images
      run: |
        cd mvp
        echo "ğŸ”¨ Building Docker Compose services..."
        docker-compose build --no-cache --parallel
        
    - name: ğŸ“¦ List built images
      run: |
        echo "ğŸ“‹ Docker images created:"
        docker images | grep -E "(mvp|stolen-bike)" || docker images | head -10
        
    # ========================================
    # ğŸ§ª TEST PHASE
    # ========================================
    - name: ğŸš€ Start services
      run: |
        cd mvp
        echo "ğŸš€ Starting services in background..."
        docker-compose up -d
        
    - name: â³ Wait for services startup
      run: |
        cd mvp
        echo "â³ Waiting for services to initialize..."
        sleep 30
        
        echo "ğŸ“Š Container status:"
        docker-compose ps
        
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Running health checks..."
        
        # Function to test service health with retries
        test_health() {
          local service_name=$1
          local port=$2
          local max_attempts=5
          
          for i in $(seq 1 $max_attempts); do
            echo "Testing $service_name (attempt $i/$max_attempts)..."
            if curl -f http://localhost:$port/health; then
              echo "âœ… $service_name is healthy"
              return 0
            else
              echo "â³ $service_name not ready, waiting..."
              sleep 10
            fi
          done
          
          echo "âŒ $service_name health check failed"
          docker-compose logs $service_name
          return 1
        }
        
        # Test both services
        test_health "Storage Service" 8002
        test_health "Scraper Service" 8001
        
    - name: ğŸ§ª API endpoint tests
      run: |
        echo "ğŸ§ª Testing API endpoints..."
        
        # Test Storage Service
        echo "ğŸ“¦ Storage Service API tests:"
        curl -s http://localhost:8002/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8002/results | jq '.' || echo "Results endpoint OK"
        
        # Test Scraper Service  
        echo "ğŸ” Scraper Service API tests:"
        curl -s http://localhost:8001/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8001/ | jq '.' || echo "Root endpoint OK"
        
    # ========================================
    # ğŸ“Š MONITORING PHASE  
    # ========================================
    - name: ğŸ“Š Service monitoring
      run: |
        cd mvp
        echo "ğŸ“Š Service status and performance:"
        
        echo "=== CONTAINER STATUS ==="
        docker-compose ps
        
        echo "=== RESOURCE USAGE ==="
        docker stats --no-stream
        
        echo "=== DISK USAGE ==="
        df -h
        
        echo "=== SCRAPER SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 scraper-service
        
        echo "=== STORAGE SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 storage-service
        
    # ========================================
    # ğŸš€ DEPLOY PHASE (Future: Deploy to your K8s cluster)
    # ========================================
    - name: ğŸš€ Deployment preparation
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸš€ Preparing for deployment to Kubernetes..."
        echo "âœ… Build successful - ready for K8s deployment"
        echo "ğŸ“¦ Images built and tested successfully"
        echo "ğŸ¯ Next step: Deploy to your EC2 Kubernetes cluster"
        
        # In the future, this is where we'll add:
        # - Push images to registry
        # - Deploy to your Kubernetes cluster
        # - Run post-deployment tests
        
    # ========================================
    # ğŸ§¹ CLEANUP PHASE
    # ========================================
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        cd mvp
        echo "ğŸ§¹ Cleaning up resources..."
        docker-compose down -v
        docker system prune -f --volumes
        
    # ========================================
    # ğŸ“ˆ RESULTS SUMMARY
    # ========================================
    - name: ğŸ“ˆ Build summary
      if: always()
      run: |
        echo "ğŸ“ˆ BUILD SUMMARY"
        echo "================="
        echo "ğŸ—“ï¸  Date: $(date)"
        echo "ğŸŒ¿  Branch: ${{ github.ref_name }}"
        echo "ğŸ’¾  Commit: ${{ github.sha }}"
        echo "ğŸ‘¤  Actor: ${{ github.actor }}"
        echo "ğŸ”„  Event: ${{ github.event_name }}"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ…  Status: SUCCESS"
          echo "ğŸ‰  All tests passed!"
          echo "ğŸš€  Ready for deployment!"
        else
          echo "âŒ  Status: FAILED"
          echo "ğŸ”  Check logs above for details"
        fi
