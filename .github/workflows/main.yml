name: ğŸš´ Stolen Bike Finder - CI/CD

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  ECR_REGISTRY: 946624007274.dkr.ecr.eu-north-1.amazonaws.com

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ========================================
    # ğŸ”„ SETUP PHASE
    # ========================================
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1
        
    - name: ğŸ·ï¸ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Install docker-compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
      
    - name: ğŸ”§ Create data directory
      run: |
        cd mvp
        mkdir -p data
        chmod 755 data
        
    # ========================================
    # ğŸ—ï¸ BUILD PHASE
    # ========================================
    - name: ğŸ—ï¸ Build Docker images
      run: |
        cd mvp
        echo "ğŸ”¨ Building Docker Compose services..."
        docker-compose build --no-cache --parallel
        
        echo "ğŸ·ï¸ Tagging images for ECR..."
        # Tag scraper service
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:latest
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}
        
        # Tag storage service  
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:latest
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}
        
    - name: ğŸ“¦ List built images
      run: |
        echo "ğŸ“‹ Docker images created:"
        docker images | grep -E "(mvp|stolen-bike)" || docker images | head -10
        
    # ========================================
    # ğŸ§ª TEST PHASE
    # ========================================
    - name: ğŸš€ Start services
      run: |
        cd mvp
        echo "ğŸš€ Starting services in background..."
        docker-compose up -d
        
    - name: â³ Wait for services startup
      run: |
        cd mvp
        echo "â³ Waiting for services to initialize..."
        sleep 30
        
        echo "ğŸ“Š Container status:"
        docker-compose ps
        
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Running health checks..."
        
        # Function to test service health with retries
        test_health() {
          local service_name=$1
          local port=$2
          local max_attempts=5
          
          for i in $(seq 1 $max_attempts); do
            echo "Testing $service_name (attempt $i/$max_attempts)..."
            if curl -f http://localhost:$port/health; then
              echo "âœ… $service_name is healthy"
              return 0
            else
              echo "â³ $service_name not ready, waiting..."
              sleep 10
            fi
          done
          
          echo "âŒ $service_name health check failed"
          docker-compose logs $service_name
          return 1
        }
        
        # Test both services
        test_health "Storage Service" 8002
        test_health "Scraper Service" 8001
        
    - name: ğŸ§ª API endpoint tests
      run: |
        echo "ğŸ§ª Testing API endpoints..."
        
        # Test Storage Service
        echo "ğŸ“¦ Storage Service API tests:"
        curl -s http://localhost:8002/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8002/results | jq '.' || echo "Results endpoint OK"
        
        # Test Scraper Service  
        echo "ğŸ” Scraper Service API tests:"
        curl -s http://localhost:8001/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8001/ | jq '.' || echo "Root endpoint OK"
        
    # ========================================
    # ğŸ“Š MONITORING PHASE  
    # ========================================
    - name: ğŸ“Š Service monitoring
      run: |
        cd mvp
        echo "ğŸ“Š Service status and performance:"
        
        echo "=== CONTAINER STATUS ==="
        docker-compose ps
        
        echo "=== RESOURCE USAGE ==="
        docker stats --no-stream
        
        echo "=== DISK USAGE ==="
        df -h
        
        echo "=== SCRAPER SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 scraper-service
        
        echo "=== STORAGE SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 storage-service
        
    # ========================================
    # ğŸš€ DEPLOY PHASE - Push to ECR
    # ========================================
    - name: ğŸš€ Push images to ECR
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: |
        echo "ğŸš€ Pushing images to Amazon ECR..."
        
        echo "ğŸ“¦ Pushing scraper service..."
        docker push $ECR_REGISTRY/stolen-bike-scraper:latest
        docker push $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}
        
        echo "ğŸ“¦ Pushing storage service..."
        docker push $ECR_REGISTRY/stolen-bike-storage:latest
        docker push $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}
        
        echo "âœ… All images pushed successfully!"
        echo "ğŸ·ï¸ Images available at:"
        echo "   - $ECR_REGISTRY/stolen-bike-scraper:latest"
        echo "   - $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}"
        echo "   - $ECR_REGISTRY/stolen-bike-storage:latest"
        echo "   - $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}"
        
    # ========================================
    # ğŸ§¹ CLEANUP PHASE
    # ========================================
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        cd mvp
        echo "ğŸ§¹ Cleaning up resources..."
        docker-compose down -v
        docker system prune -f --volumes
        
    # ========================================
    # ğŸ“ˆ RESULTS SUMMARY
    # ========================================
    - name: ğŸ“ˆ Build summary
      if: always()
      run: |
        echo "ğŸ“ˆ BUILD SUMMARY"
        echo "================="
        echo "ğŸ—“ï¸  Date: $(date)"
        echo "ğŸŒ¿  Branch: ${{ github.ref_name }}"
        echo "ğŸ’¾  Commit: ${{ github.sha }}"
        echo "ğŸ‘¤  Actor: ${{ github.actor }}"
        echo "ğŸ”„  Event: ${{ github.event_name }}"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ…  Status: SUCCESS"
          echo "ğŸ‰  All tests passed!"
          echo "ğŸš€  Ready for deployment!"
        else
          echo "âŒ  Status: FAILED"
          echo "ğŸ”  Check logs above for details"
        fi
