name: ğŸš´ Stolen Bike Finder - CI/CD

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  ECR_REGISTRY: public.ecr.aws/u7w7e7d5

jobs:
  # ========================================
  # ğŸ—ï¸ BUILD JOB
  # ========================================
  build:
    name: ğŸ—ï¸ Build Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ github.sha }}
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“¦ Install docker-compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
      
    - name: ğŸ”§ Create data directory
      run: |
        cd mvp
        mkdir -p data
        chmod 755 data
        
    - name: ğŸ—ï¸ Build Docker images
      run: |
        cd mvp
        echo "ğŸ”¨ Building Docker Compose services..."
        docker-compose build --no-cache --parallel
        
    - name: ğŸ·ï¸ Tag images for ECR
      run: |
        echo "ğŸ·ï¸ Tagging images for ECR..."
        # Tag scraper service
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:latest
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}
        
        # Tag storage service  
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:latest
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}
        
    - name: ğŸ“¦ List built images
      run: |
        echo "ğŸ“‹ Docker images created:"
        docker images | grep -E "(mvp|stolen-bike)" || docker images | head -10
        
    - name: ğŸ’¾ Save Docker images
      run: |
        echo "ğŸ’¾ Saving Docker images for testing..."
        docker save mvp_scraper-service:latest mvp_storage-service:latest | gzip > docker-images.tar.gz
        
    - name: â¬†ï¸ Upload images artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-images
        path: docker-images.tar.gz
        retention-days: 1

  # ========================================
  # ğŸ§ª TEST JOB
  # ========================================
  test:
    name: ğŸ§ª Test Services
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Install docker-compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose jq
      
    - name: â¬‡ï¸ Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-images
        
    - name: ğŸ“‚ Load Docker images
      run: |
        echo "ğŸ“‚ Loading Docker images..."
        gunzip -c docker-images.tar.gz | docker load
        
    - name: ï¿½ Create data directory
      run: |
        cd mvp
        mkdir -p data
        chmod 755 data
        
    - name: ï¿½ğŸš€ Start services
      run: |
        cd mvp
        echo "ğŸš€ Starting services in background..."
        docker-compose up -d
        
    - name: â³ Wait for services startup
      run: |
        cd mvp
        echo "â³ Waiting for services to initialize..."
        sleep 30
        
        echo "ğŸ“Š Container status:"
        docker-compose ps
        
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Running health checks..."
        
        # Function to test service health with retries
        test_health() {
          local service_name=$1
          local port=$2
          local max_attempts=5
          
          for i in $(seq 1 $max_attempts); do
            echo "Testing $service_name (attempt $i/$max_attempts)..."
            if curl -f http://localhost:$port/health; then
              echo "âœ… $service_name is healthy"
              return 0
            else
              echo "â³ $service_name not ready, waiting..."
              sleep 10
            fi
          done
          
          echo "âŒ $service_name health check failed"
          docker-compose logs $service_name
          return 1
        }
        
        # Test both services
        test_health "Storage Service" 8002
        test_health "Scraper Service" 8001
        
    - name: ğŸ§ª API endpoint tests
      run: |
        echo "ğŸ§ª Testing API endpoints..."
        
        # Test Storage Service
        echo "ğŸ“¦ Storage Service API tests:"
        curl -s http://localhost:8002/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8002/results | jq '.' || echo "Results endpoint OK"
        
        # Test Scraper Service  
        echo "ğŸ” Scraper Service API tests:"
        curl -s http://localhost:8001/health | jq '.' || echo "Health endpoint OK"
        curl -s http://localhost:8001/ | jq '.' || echo "Root endpoint OK"
        
    - name: ğŸ“Š Service monitoring
      run: |
        cd mvp
        echo "ğŸ“Š Service status and performance:"
        
        echo "=== CONTAINER STATUS ==="
        docker-compose ps
        
        echo "=== RESOURCE USAGE ==="
        docker stats --no-stream
        
        echo "=== SCRAPER SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 scraper-service
        
        echo "=== STORAGE SERVICE LOGS (Last 30 lines) ==="
        docker-compose logs --tail=30 storage-service
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        cd mvp
        echo "ğŸ§¹ Cleaning up test resources..."
        docker-compose down -v

  # ========================================
  # ğŸš€ DEPLOY JOB
  # ========================================
  deploy:
    name: ğŸš€ Deploy to ECR
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: ğŸ·ï¸ Login to Amazon ECR Public
      id: login-ecr-public
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: public
      
    - name: â¬‡ï¸ Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-images
        
    - name: ğŸ“‚ Load Docker images
      run: |
        echo "ï¿½ Loading Docker images..."
        gunzip -c docker-images.tar.gz | docker load
        
    - name: ğŸ·ï¸ Re-tag images for ECR
      run: |
        echo "ğŸ·ï¸ Re-tagging images for ECR..."
        # Tag scraper service
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:latest
        docker tag mvp_scraper-service:latest $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}
        
        # Tag storage service  
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:latest
        docker tag mvp_storage-service:latest $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}
        
    - name: ï¿½ğŸš€ Push images to ECR
      run: |
        echo "ğŸš€ Pushing images to Amazon ECR..."
        
        echo "ğŸ“¦ Pushing scraper service..."
        docker push $ECR_REGISTRY/stolen-bike-scraper:latest
        docker push $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}
        
        echo "ğŸ“¦ Pushing storage service..."
        docker push $ECR_REGISTRY/stolen-bike-storage:latest
        docker push $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}
        
        echo "âœ… All images pushed successfully!"
        echo "ğŸ·ï¸ Images available at:"
        echo "   - $ECR_REGISTRY/stolen-bike-scraper:latest"
        echo "   - $ECR_REGISTRY/stolen-bike-scraper:${{ github.sha }}"
        echo "   - $ECR_REGISTRY/stolen-bike-storage:latest"
        echo "   - $ECR_REGISTRY/stolen-bike-storage:${{ github.sha }}"

  # ========================================
  # ğŸ“ˆ SUMMARY JOB
  # ========================================
  summary:
    name: ğŸ“ˆ Build Summary
    runs-on: ubuntu-latest
    needs: [build, test, deploy]
    if: always()
    
    steps:
    - name: ğŸ“ˆ Workflow summary
      run: |
        echo "ğŸ“ˆ WORKFLOW SUMMARY"
        echo "==================="
        echo "ğŸ—“ï¸  Date: $(date)"
        echo "ğŸŒ¿  Branch: ${{ github.ref_name }}"
        echo "ğŸ’¾  Commit: ${{ github.sha }}"
        echo "ğŸ‘¤  Actor: ${{ github.actor }}"
        echo "ğŸ”„  Event: ${{ github.event_name }}"
        echo ""
        echo "ğŸ—ï¸  Build: ${{ needs.build.result }}"
        echo "ğŸ§ª  Test: ${{ needs.test.result }}"
        echo "ğŸš€  Deploy: ${{ needs.deploy.result }}"
        echo ""
        
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.test.result }}" == "success" ]]; then
          echo "âœ… CI Pipeline: SUCCESS"
          echo "ğŸ‰ All tests passed!"
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "ğŸš€ Deployment: SUCCESS"
            echo "ğŸ“¦ Images pushed to ECR!"
          elif [[ "${{ needs.deploy.result }}" == "skipped" ]]; then
            echo "â­ï¸  Deployment: SKIPPED (not master branch or not push event)"
          fi
        else
          echo "âŒ CI Pipeline: FAILED"
          echo "ğŸ” Check job logs above for details"
        fi
